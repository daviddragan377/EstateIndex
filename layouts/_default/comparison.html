{{ define "main" }}
<div class="py-12 px-4 sm:px-6 lg:px-8">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-4xl font-serif font-bold text-gray-900 mb-4">
      Property Comparison
    </h1>
    <p class="text-gray-600 mb-12">
      Compare up to 2 properties side-by-side. Select properties from the listings page.
    </p>
    
    <div id="comparison-container" class="space-y-8">
      <!-- Comparison Table -->
      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
        <table class="w-full">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Attribute</th>
              <th id="property-1-header" class="px-6 py-4 text-left text-sm font-semibold text-gray-900 border-l border-gray-200">Property 1</th>
              <th id="property-2-header" class="px-6 py-4 text-left text-sm font-semibold text-gray-900 border-l border-gray-200">Property 2</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200" id="comparison-rows">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
      
      <!-- Empty State -->
      <div id="empty-state" class="text-center py-16 bg-gray-50 rounded-lg border border-gray-200">
        <p class="text-gray-600 mb-6">
          No properties selected for comparison.
        </p>
        <a href="{{ relURL "listings/" }}" class="inline-block px-6 py-3 bg-gradient-to-r from-blue-900 to-blue-800 text-white font-semibold rounded-lg hover:shadow-lg transition-shadow">
          Browse Listings
        </a>
      </div>
      
      <!-- Pros & Cons (if both selected) -->
      <div id="pros-cons" class="grid grid-cols-1 md:grid-cols-2 gap-8 hidden">
        <div class="bg-green-50 p-6 rounded-lg border border-green-200">
          <h3 class="text-lg font-serif font-bold text-green-900 mb-4">Advantages</h3>
          <ul id="advantages-list" class="space-y-2 text-sm text-gray-700">
            <!-- Populated by JS -->
          </ul>
        </div>
        <div class="bg-amber-50 p-6 rounded-lg border border-amber-200">
          <h3 class="text-lg font-serif font-bold text-amber-900 mb-4">Considerations</h3>
          <ul id="considerations-list" class="space-y-2 text-sm text-gray-700">
            <!-- Populated by JS -->
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Comparison logic
class Comparison {
  constructor() {
    this.properties = this.loadFromStorage();
  }
  
  loadFromStorage() {
    const stored = localStorage.getItem('comparison');
    return stored ? JSON.parse(stored) : [];
  }
  
  save() {
    localStorage.setItem('comparison', JSON.stringify(this.properties.slice(0, 2)));
  }
  
  add(propertyId) {
    if (!this.properties.includes(propertyId) && this.properties.length < 2) {
      this.properties.push(propertyId);
      this.save();
    }
  }
  
  remove(propertyId) {
    this.properties = this.properties.filter(id => id !== propertyId);
    this.save();
  }
  
  clear() {
    this.properties = [];
    this.save();
  }
}

const comparison = new Comparison();
const params = new URLSearchParams(window.location.search);

if (params.has('add')) {
  comparison.add(params.get('add'));
  window.location.href = '/compare/';
}

if (params.has('remove')) {
  comparison.remove(params.get('remove'));
  window.location.href = '/compare/';
}

// Render comparison
function renderComparison() {
  if (comparison.properties.length === 0) {
    document.getElementById('empty-state').classList.remove('hidden');
    document.getElementById('comparison-container').querySelector('table').parentElement.classList.add('hidden');
    return;
  }
  
  document.getElementById('empty-state').classList.add('hidden');
  document.getElementById('comparison-container').querySelector('table').parentElement.classList.remove('hidden');
  
  // Fetch property data and render
  Promise.all(comparison.properties.map(id => 
    fetch(`/listings/${id}/index.json`).then(r => r.json()).catch(() => null)
  )).then(properties => {
    properties = properties.filter(p => p);
    renderComparisonTable(properties);
  });
}

function renderComparisonTable(properties) {
  const rows = document.getElementById('comparison-rows');
  const attributes = ['title', 'price', 'location', 'country', 'listingtype', 'bedrooms', 'bathrooms', 'area'];
  
  rows.innerHTML = '';
  attributes.forEach(attr => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="px-6 py-4 text-sm font-semibold text-gray-900 bg-gray-50">${attr}</td>
      <td class="px-6 py-4 text-sm text-gray-700 border-l border-gray-200">${properties[0]?.[attr] || '-'}</td>
      <td class="px-6 py-4 text-sm text-gray-700 border-l border-gray-200">${properties[1]?.[attr] || '-'}</td>
    `;
    rows.appendChild(row);
  });
}

renderComparison();
</script>
{{ end }}

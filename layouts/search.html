{{- define "main" -}}
<div class="search-container">
  <div class="search-header">
    <h1>{{ .Title }}</h1>
    <p class="lead">{{ .Description }}</p>
  </div>

  <!-- Search & Filter Sidebar -->
  <div class="search-layout">
    <aside class="search-filters">
      <div class="filter-section">
        <h3>Countries</h3>
        <div class="filter-options">
          {{- $countries := slice }}
          {{- range where site.RegularPages "Section" "listings" }}
            {{- range .Params.countries }}
              {{- if not (in $countries .) }}
                {{- $countries = $countries | append . }}
              {{- end }}
            {{- end }}
          {{- end }}
          {{- range sort $countries }}
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="country" value="{{ . }}" />
              <span>{{ . }}</span>
            </label>
          {{- end }}
        </div>
      </div>

      <div class="filter-section">
        <h3>Locations</h3>
        <div class="filter-options">
          {{- $locations := slice }}
          {{- range where site.RegularPages "Section" "listings" }}
            {{- range .Params.locations }}
              {{- if not (in $locations .) }}
                {{- $locations = $locations | append . }}
              {{- end }}
            {{- end }}
          {{- end }}
          {{- range first 15 (sort $locations) }}
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="location" value="{{ . }}" />
              <span>{{ . }}</span>
            </label>
          {{- end }}
        </div>
      </div>

      <div class="filter-section">
        <h3>Property Type</h3>
        <div class="filter-options">
          {{- $types := slice }}
          {{- range where site.RegularPages "Section" "listings" }}
            {{- if .Params.listingtype }}
              {{- if not (in $types .Params.listingtype) }}
                {{- $types = $types | append .Params.listingtype }}
              {{- end }}
            {{- end }}
          {{- end }}
          {{- range sort $types }}
            {{- if . }}
              <label class="filter-checkbox">
                <input type="checkbox" class="filter-input" data-filter="type" value="{{ . }}" />
                <span>{{ . }}</span>
              </label>
            {{- end }}
          {{- end }}
        </div>
      </div>

      <div class="filter-section">
        <h3>Bedrooms</h3>
        <div class="filter-options">
          {{- range seq 1 5 }}
            <label class="filter-checkbox">
              <input type="checkbox" class="filter-input" data-filter="bedrooms" value="{{ . }}" />
              <span>{{ . }}{{ if gt . 1 }}+ {{end}}</span>
            </label>
          {{- end }}
        </div>
      </div>

      <button id="reset-filters" class="btn btn-secondary btn-block mt-3">Reset Filters</button>
    </aside>

    <!-- Results -->
    <main class="search-results">
      <div class="results-header">
        <h2>Results <span id="result-count"></span></h2>
        <div class="sort-options">
          <select id="sort-select" class="form-control">
            <option value="">Sort by...</option>
            <option value="price-asc">Price: Low to High</option>
            <option value="price-desc">Price: High to Low</option>
            <option value="title-asc">Title: A to Z</option>
            <option value="title-desc">Title: Z to A</option>
          </select>
        </div>
      </div>

      <div id="listings-grid" class="listings-grid">
        {{- range where site.RegularPages "Section" "listings" }}
          {{- if not .Draft }}
            {{- partial "listing-card" . }}
          {{- end }}
        {{- end }}
      </div>

      <div id="no-results" class="alert alert-info" style="display: none;">
        <p>No properties match your search criteria. Try adjusting your filters.</p>
      </div>
    </main>
  </div>
</div>

<style>
.search-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
}

.search-header {
  margin-bottom: 2rem;
}

.search-layout {
  display: grid;
  grid-template-columns: 250px 1fr;
  gap: 2rem;
}

.search-filters {
  background: #f5f5f5;
  padding: 1.5rem;
  border-radius: 8px;
  height: fit-content;
  position: sticky;
  top: 100px;
}

.filter-section {
  margin-bottom: 1.5rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid #ddd;
}

.filter-section:last-child {
  border-bottom: none;
}

.filter-section h3 {
  font-size: 1rem;
  margin-bottom: 0.75rem;
  font-weight: 600;
}

.filter-options {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.filter-checkbox {
  display: flex;
  align-items: center;
  cursor: pointer;
  font-size: 0.95rem;
}

.filter-checkbox input {
  margin-right: 0.5rem;
  cursor: pointer;
}

.results-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
}

.sort-options {
  min-width: 200px;
}

.listings-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 1.5rem;
}

.btn-block {
  width: 100%;
}

.mt-3 {
  margin-top: 1rem;
}

@media (max-width: 768px) {
  .search-layout {
    grid-template-columns: 1fr;
  }

  .search-filters {
    position: static;
  }

  .listings-grid {
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  }
}
</style>

<script>
// Parse URL parameters
function getUrlParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    country: params.get('country') || '',
    location: params.get('location') || '',
    type: params.get('type') || '',
    bedrooms: params.get('bedrooms') || '',
  };
}

// Get all listings from the page
function getAllListings() {
  return Array.from(document.querySelectorAll('[data-listing]')).map(el => ({
    element: el,
    country: el.dataset.country || '',
    location: el.dataset.location || '',
    type: el.dataset.type || '',
    bedrooms: parseInt(el.dataset.bedrooms) || 0,
    price: parseInt(el.dataset.price) || 0,
    title: el.dataset.title || '',
  }));
}

// Filter listings based on selected filters
function filterListings() {
  const allListings = getAllListings();
  const filters = {
    country: Array.from(document.querySelectorAll('[data-filter="country"]:checked')).map(el => el.value),
    location: Array.from(document.querySelectorAll('[data-filter="location"]:checked')).map(el => el.value),
    type: Array.from(document.querySelectorAll('[data-filter="type"]:checked')).map(el => el.value),
    bedrooms: Array.from(document.querySelectorAll('[data-filter="bedrooms"]:checked')).map(el => parseInt(el.value)),
  };

  const filtered = allListings.filter(listing => {
    if (filters.country.length > 0 && !filters.country.includes(listing.country)) return false;
    if (filters.location.length > 0 && !filters.location.includes(listing.location)) return false;
    if (filters.type.length > 0 && !filters.type.includes(listing.type)) return false;
    if (filters.bedrooms.length > 0 && !filters.bedrooms.includes(listing.bedrooms)) return false;
    return true;
  });

  // Show/hide listings
  allListings.forEach(listing => {
    listing.element.style.display = filtered.includes(listing) ? '' : 'none';
  });

  // Update count
  document.getElementById('result-count').textContent = `(${filtered.length})`;
  document.getElementById('no-results').style.display = filtered.length === 0 ? 'block' : 'none';

  // Update URL
  const params = new URLSearchParams();
  if (filters.country.length > 0) params.set('country', filters.country[0]);
  if (filters.location.length > 0) params.set('location', filters.location[0]);
  if (filters.type.length > 0) params.set('type', filters.type[0]);
  if (filters.bedrooms.length > 0) params.set('bedrooms', filters.bedrooms[0]);
  
  const queryString = params.toString();
  window.history.replaceState({}, '', queryString ? `?${queryString}` : window.location.pathname);
}

// Sort listings
function sortListings() {
  const sortValue = document.getElementById('sort-select').value;
  const grid = document.getElementById('listings-grid');
  const listings = Array.from(grid.children);

  if (!sortValue) {
    filterListings();
    return;
  }

  listings.sort((a, b) => {
    let aVal, bVal;
    
    if (sortValue === 'price-asc' || sortValue === 'price-desc') {
      aVal = parseInt(a.dataset.price) || 0;
      bVal = parseInt(b.dataset.price) || 0;
      return sortValue === 'price-asc' ? aVal - bVal : bVal - aVal;
    } else if (sortValue === 'title-asc' || sortValue === 'title-desc') {
      aVal = (a.dataset.title || '').toLowerCase();
      bVal = (b.dataset.title || '').toLowerCase();
      return sortValue === 'title-asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    }
    return 0;
  });

  grid.innerHTML = '';
  listings.forEach(listing => grid.appendChild(listing));
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  const params = getUrlParams();
  
  // Pre-select filters from URL
  if (params.country) {
    document.querySelectorAll('[data-filter="country"]').forEach(el => {
      if (el.value === params.country) el.checked = true;
    });
  }
  if (params.location) {
    document.querySelectorAll('[data-filter="location"]').forEach(el => {
      if (el.value === params.location) el.checked = true;
    });
  }

  // Set up event listeners
  document.querySelectorAll('.filter-input').forEach(input => {
    input.addEventListener('change', filterListings);
  });

  document.getElementById('sort-select').addEventListener('change', sortListings);
  document.getElementById('reset-filters').addEventListener('click', function() {
    document.querySelectorAll('.filter-input:checked').forEach(el => el.checked = false);
    document.getElementById('sort-select').value = '';
    filterListings();
  });

  // Initial filter
  filterListings();
});
</script>
{{- end -}}
